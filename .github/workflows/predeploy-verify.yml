name: Pre-deploy verify

on:
  workflow_dispatch: {}
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  verify-secrets-and-db:
    name: Verify secrets and DB connectivity
    runs-on: ubuntu-latest
    env:
      REQUIRED_SECRETS: MONGODB_URI,JWT_SECRET
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Require secrets
        id: check_secrets
        run: |
          echo "Checking required secrets..."
          missing=0
          for s in $(echo "$REQUIRED_SECRETS" | tr ',' ' '); do
            val="${{ secrets["$s"] }}"
            if [ -z "$val" ]; then
              echo "ERROR: Required secret $s is not set in this repository."
              missing=1
            else
              echo "Found secret $s"
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "At least one required secret is missing. Failing.";
            exit 1;
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install backend deps
        run: |
          cd backend
          npm ci

      - name: Verify DB connectivity (using MONGODB_URI secret)
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          cd backend
          npm run verify-db
